generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id                String   @id @default(uuid())
  name              String   @db.VarChar(255)
  email             String?  @db.VarChar(255)
  address           String?  @db.Text
  defaultHourlyRate Decimal  @default(0) @db.Decimal(10, 2)
  notes             String?  @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  invoices         Invoice[]
  timesheetEntries TimesheetEntry[]
  charges          Charge[]
  importBatches    ImportBatch[]

  @@map("customers")
}

model Invoice {
  id                 String        @id @default(uuid())
  invoiceNumber      String        @unique @db.VarChar(50)
  customerId         String
  status             InvoiceStatus @default(draft)
  hourlyRateOverride Decimal?      @db.Decimal(10, 2)
  subtotal           Decimal       @default(0) @db.Decimal(10, 2)
  taxRate            Decimal       @default(0) @db.Decimal(5, 4)
  taxAmount          Decimal       @default(0) @db.Decimal(10, 2)
  total              Decimal       @default(0) @db.Decimal(10, 2)
  notes              String?       @db.Text
  dueDate            DateTime?     @db.Date
  sentAt             DateTime?
  paidAt             DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  customer Customer           @relation(fields: [customerId], references: [id], onDelete: Restrict)
  entries  TimesheetEntry[]
  charges  Charge[]
  emails   EmailLog[]

  @@index([customerId])
  @@index([status])
  @@map("invoices")
}

model Charge {
  id          String     @id @default(uuid())
  invoiceId   String?
  customerId  String
  chargeType  ChargeType
  description String     @db.Text
  quantity    Decimal    @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal    @db.Decimal(10, 2)
  total       Decimal    @db.Decimal(10, 2)
  chargeDate  DateTime   @db.Date
  notes       String?    @db.Text
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  invoice  Invoice?  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  customer Customer  @relation(fields: [customerId], references: [id], onDelete: Restrict)

  @@index([customerId])
  @@index([invoiceId])
  @@index([chargeDate])
  @@map("charges")
}

model TimesheetEntry {
  id                 String   @id @default(uuid())
  invoiceId          String?
  customerId         String
  entryDate          DateTime @db.Date
  startTime          String?  @db.VarChar(10)
  endTime            String?  @db.VarChar(10)
  totalMinutes       Int
  taskDescription    String   @db.Text
  requestor          String?  @db.VarChar(255)
  hourlyRateOverride Decimal? @db.Decimal(10, 2)
  calculatedCost     Decimal  @db.Decimal(10, 2)
  importBatchId      String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  invoice     Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  customer    Customer     @relation(fields: [customerId], references: [id], onDelete: Restrict)
  importBatch ImportBatch? @relation(fields: [importBatchId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([invoiceId])
  @@index([entryDate])
  @@map("timesheet_entries")
}

model Setting {
  key       String   @id @db.VarChar(100)
  value     Json
  updatedAt DateTime @updatedAt

  @@map("settings")
}

model EmailLog {
  id               String      @id @default(uuid())
  invoiceId        String?
  recipientEmail   String      @db.VarChar(255)
  subject          String      @db.VarChar(255)
  status           EmailStatus
  mailgunMessageId String?     @db.VarChar(255)
  errorMessage     String?     @db.Text
  sentAt           DateTime    @default(now())

  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@map("email_logs")
}

model ImportBatch {
  id           String   @id @default(uuid())
  filename     String   @db.VarChar(255)
  customerId   String
  entriesCount Int
  totalMinutes Int
  totalCost    Decimal  @db.Decimal(10, 2)
  importedAt   DateTime @default(now())

  customer Customer         @relation(fields: [customerId], references: [id], onDelete: Restrict)
  entries  TimesheetEntry[]

  @@map("import_batches")
}

enum InvoiceStatus {
  draft
  sent
  paid
  overdue
  cancelled
}

enum EmailStatus {
  sent
  failed
  bounced
}

enum ChargeType {
  service        // Monthly/recurring service fees
  software       // Software licenses
  hardware       // Physical items/hardware
  consulting     // One-time consulting fees
  expense        // Reimbursable expenses
  other          // Miscellaneous charges
}
